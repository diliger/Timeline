<script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<dom-module id="timeline-element">
    <template>
        <style>
            /*g.event.critical rect.bar {
                fill: rgba(255, 0, 0, 0.50);
            }*/

            /*.axis path,
            .axis line {
                fill: none;
                stroke: #000;
                shape-rendering: crispEdges;
            }*/
        </style>
        <p id="header">The <b>{{name}}</b> timeline.</p>
        <div id="chart">

        </div>
    </template>
    <script>
        // register a new element called proto-element
        Polymer({
            is: "timeline-element",
            properties: {
                name: { type: String },
                description: { type: String },
                width: { type: Number },
                height: { type: Number },
                color: { type: String, value: "#A8AAFF" },
                items: {
                    type: Array
                },
                events: {
                    type: Array
                }
            },
            observers: ["itemsAddedOrRemoved(items.splices)", "itemsChanged(items.*)", "eventsAddedOrRemoved(events.splices)", "eventsChanged(events.*)"],
            itemsChanged: function (changeRecord) {
                setTimeout(function () {
                    this.updateChart();
                }.bind(this), 50);
            },
            itemsAddedOrRemoved: function (changeRecord) {
                setTimeout(function () {
                    this.updateChart();
                }.bind(this), 50);
            },
            eventsChanged: function (changeRecord) {
                setTimeout(function () {
                    this.updateChart();
                }.bind(this), 50);
            },
            eventsAddedOrRemoved: function (changeRecord) {
                setTimeout(function () {
                    this.updateChart();
                }.bind(this), 50);
            },
            ready: function () {
                this.attachedFired = true;
                this.width = this.width || 600;
                this.height = this.height || 250;

                setTimeout(function () {
                    this.initChart();
                }.bind(this), 50);
            },
            labelStyle: "text-anchor: middle;" +
                        "font-family: sans-serif;" +
                        "font-size: 13px;" +
                        "font-weight: bold;" +
                        "fill: white;" +
                        "text-shadow: 0px 0px 10px rgba(10, 10, 10, 1);",
            axisLabelStyle: "fill: white;" +
                            "stroke: #FFF;" +
                            "shape-rendering: crispEdges;",
            initChart: function () {
                if (!this.attachedFired)
                    return;
                var me = this;
                //console.warn(me.events);
                //Width and height
                var footer = 150;
                var w = this.width - 40;
                var h = this.height - footer - 40;

                var key = me.key = function (d) {
                    return d.Key;
                };
                var label = me.label = function (d) {
                    var prefix = "";// d.Key + ": ";
                    if (d.Value > 0 && d.Predicted > 0)
                        return prefix + '<tspan dy="-1.2em">' + d.Value + '</tspan> <tspan dy="1.2em">(' + d.Predicted + "?)</tspan>";
                    else if (d.Value > 0)
                        return prefix + d.Value;
                    else if (d.Predicted > 0)
                        return prefix + d.Predicted + "?";
                    return prefix + "";
                }

                me.xScale = d3.scale.ordinal()
                                .domain(d3.range(1, d3.max(this.items, function (d) { return d.Key; }) + 1))
                                .rangeRoundBands([0, w], 0.02);

                xEventScale = me.xEventScale = d3.scale.linear()
                                .domain([0, d3.max(this.items, function (d) { return d.Key * 1; })])
                                .range([0, w]);

                me.yScale = d3.scale.linear()
                                .domain([0, d3.max(this.items, function (d) { return Math.max(d.Predicted, d.Value); })])
                                .range([0, h]);

                me.eventXFrom = function (d, i) { return d.From % 1 == 0 ? me.xScale(d.From + 1) : me.xEventScale(d.From); };
                me.eventXTo = function (d, i) { return d.To % 1 == 0 ? me.xScale(d.To) + me.xScale.rangeBand() : me.xEventScale(d.To); };

                me.xAxis = d3.svg.axis()
                    .scale(me.xScale)
                    .tickFormat(function (d) { return "w" + d; })
                    .orient("bottom");

                //Create SVG element
                var svg = me.svg = d3.select(this.$.chart)
                            .append("svg")
                            .attr("width", this.width)
                            .attr("style", "padding: 20px; background-color: #eaeaea;")
                            .attr("height", this.height);

                var axis = svg.append("g")
                   .attr("class", "x axis")
                   .attr("transform", "translate(0," + (h + 20) + ")")
                   .call(me.xAxis);

                axis.select("path")
                .style("display", "none");

                axis.selectAll(".tick line")
                .attr("style", me.axisLabelStyle);

                axis.selectAll(".tick text")
                .attr("style", me.labelStyle);

                me.itemsEnter();

                me.eventsEnter();

                this.initialized = true;
            },
            updateChart: function () {
                if (!this.initialized)
                    return;

                var me = this;
                //Width and height
                var footer = 150;
                var w = this.width - 40;
                var h = this.height - footer - 40;

                //Update scale domain
                me.yScale.domain([0, d3.max(this.items, function (d) { return Math.max(d.Predicted, d.Value); })]);
                me.xScale.domain(d3.range(1, d3.max(this.items, function (d) { return d.Key; }) + 1));
                me.xEventScale.domain([0, d3.max(this.items, function (d) { return d.Key; })]);

                //Update x-axis
                var axis = me.svg.select(".x.axis")
                   .call(me.xAxis);

                axis.select("path")
                .style("display", "none");

                axis.selectAll(".tick line")
                .attr("style", me.axisLabelStyle);

                axis.selectAll(".tick text")
                .attr("style", me.labelStyle);

                var items = me.svg.selectAll(".item")
                  .data(me.items, me.key);

                //Exit…
                items.exit()
                    .transition()
                    .duration(500)
                    .attr("transform", function (d, i) { return "translate(" + -me.xScale.rangeBand() + ",0)"; })  // <-- Exit stage left
                    .remove();

                me.itemsEnter();

                var events = me.svg.selectAll(".event")
                    .data(me.events);

                events.exit()
                    //.transition()
                    //.duration(500)
                    //.attr("x", 0)  // <-- Exit stage left
                    .remove();

                me.eventsEnter();

            },
            itemsEnter: function () {
                var me = this;
                //Width and height
                var footer = 150;
                var w = this.width - 40;
                var h = this.height - footer - 40;

                var items = me.svg.selectAll(".item")
                   .data(me.items, me.key)
                   .enter()
                   .append("g")
                   .attr("class", "item");

                items.append("rect")
                   .attr("class", "predicted");

                items.append("rect")
                   .attr("class", "value");

                //Create labels
                items.append("text")
                   .attr("class", "label");

                me.itemsUpdate();
            },
            itemsUpdate: function () {
                var me = this;
                //Width and height
                var footer = 150;
                var w = this.width - 40;
                var h = this.height - footer - 40;

                var items = me.svg.selectAll(".item")
                   .data(me.items, me.key)
                   .attr("class", "item")
                   .attr("transform", function (d, i) { return "translate(" + me.xScale(d.Key) + ",0)"; });

                items.selectAll("rect.predicted")
                   .attr("opacity", 0.5)
                   .attr("y", function (d) {
                       return h - me.yScale(d.Predicted) + 20;
                   })
                   .attr("width", me.xScale.rangeBand())
                   .attr("height", function (d) {
                       return me.yScale(d.Predicted);
                   })
                   .attr("fill", function (d) {
                       return me.color;
                   });

                items.selectAll("rect.value")
                   .attr("y", function (d) {
                       return h - me.yScale(d.Value) + 20;
                   })
                   .attr("width", me.xScale.rangeBand())
                   .attr("height", function (d) {
                       return me.yScale(d.Value);
                   })
                   .attr("fill", function (d) {
                       return me.color;
                   });

                //Create labels
                items
                   .selectAll("text")
                   .html(me.label)
                   .attr("style", me.labelStyle)
                   .attr("x", function (d, i) {
                       return me.xScale.rangeBand() / 2;
                   })
                   .attr("y", function (d) {
                       return h - me.yScale(Math.max(d.Predicted, d.Value)) - 5 + 20;
                   })
                   .attr("class", "label")
                   .selectAll("tspan")
                    .attr("x", function (d, i) {
                        return me.xScale.rangeBand() / 2;
                    });
            },
            eventsEnter: function () {
                var me = this;
                //Width and height
                var footer = 150;
                var w = this.width - 40;
                var h = this.height - footer - 40;

                var events = me.svg.selectAll(".event")
                   .data(me.events)
                   .enter()
                   .append("g")
                   .attr("class", "event ");

                events.append("rect")
                   .attr("class", "bar")
                   .attr("opacity", 0.3);

                events = events.append("g")
                   .attr("class", "label");

                events.append("rect")
                   .attr("class", "name");

                events.append("text")
                   .attr("class", "label");

                me.eventsUpdate();
            },
            eventsUpdate: function () {
                var me = this;
                //Width and height
                var footer = 150;
                var w = this.width - 40;
                var h = this.height - footer - 40;

                var events = me.svg.selectAll(".event")
                   .attr("class", function (d) {
                       return "event " + (d.Type || "").toLowerCase();
                   })
                   .attr("transform", function (d, i) { return "translate(" + me.eventXFrom(d) + ",0)"; });

                events.select("rect.bar")
                   .attr("y", function (d) {
                       var w = me.eventXTo(d) - me.eventXFrom(d);
                       return w <= 0 ? h + 20 : 0;
                   })
                   .attr("class", "bar")
                   .attr("opacity", function (d) {
                       var w = me.eventXTo(d) - me.eventXFrom(d);
                       return w <= 0 ? 1 : 0.3;
                   })
                   .attr("width", function (d) {
                       var w = me.eventXTo(d) - me.eventXFrom(d);
                       return w <= 0 ? 5 : w;
                   })
                   .attr("height", function (d) {
                       var w = me.eventXTo(d) - me.eventXFrom(d);
                       if (w <= 0) {
                           return footer / 2
                       }
                       return h + footer / 2;
                   })
                   .attr("fill", function (d) { return (d.Type || "").toLowerCase() == "critical" ? "red" : "#a3a3a3"; });

                events.select("g.label")
                   .attr("transform", function (d, i) { return "translate(0," + (h + footer / 2) + ")"; });

                //events.select("rect.name")
                //.attr("y", h + footer / 2)
                //.attr("width", function (d) {
                //    var w = me.eventXTo(d) - me.eventXFrom(d);
                //    return me.eventXTo(d) - me.eventXFrom(d);
                //})
                //.attr("height", footer / 8)
                //.attr("fill", "#70707f");

                events.select("text.label")
                   .attr("fill", "white")
                   .attr("style", me.labelStyle)
                   .attr("x", function (d) {
                       var w = me.eventXTo(d) - me.eventXFrom(d);
                       return w <= 0 ? 0 : w / 2;
                   })
                   .attr("y", "1.2em")
                   .text(function (d) { return d.Name; });

                var newEvents = [];
                events.select("rect.name")
                    .each(function (d, i, c) {
                        var text = d3.select(this.parentNode).select("text");
                        var x = text.attr("x") * 1;
                        var width = text[0][0].clientWidth * 1.5;
                        var height = text[0][0].clientHeight * 1.5;
                        if (width == 0 || height == 0 || !(x > 0)) {
                            newEvents.push(d3.select(this));
                            //.attr("opacity", 0);
                            return;
                        }
                        d3.select(this)
                            .attr("width", width)
                            .attr("x", x - width / 2)
                            .attr("height", height)
                            .attr("fill", "#70707f");
                    });

                setTimeout(function () {
                    newEvents
                        .forEach(function (d, i) {
                            var text = d3.select(d[0][0].parentNode).select("text");
                            var x = text.attr("x");
                            var width = text[0][0].clientWidth * 1.5;
                            var height = text[0][0].clientHeight * 1.5;
                            d
                                .attr("width", width)
                                .attr("x", x - width / 2)
                                .attr("height", height)
                                .attr("fill", "#70707f");
                        });
                }, 100);

                me.svg.selectAll("g.item, g.event").sort(function (a, b) {
                    return -me.events.indexOf(b);
                });
            }
        });
    </script>

</dom-module>