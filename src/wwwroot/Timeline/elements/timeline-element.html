<script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<dom-module id="timeline-element">
    <template>
        <style>
            svg {
                padding: 20px;
                background-color: #eaeaea;
            }

            rect:first-child {
                fill-opacity: .6;
            }

            text.label {
                text-anchor: middle;
                font-family: sans-serif;
                font-size: 11px;
                font-weight: bold;
                fill: white;
                text-shadow: 0px 0px 10px rgba(10, 10, 10, 1);
            }
        </style>
        <p id="header">The <b>{{name}}</b> timeline.</p>
        <div id="chart">

        </div>
    </template>
    <script>
        // register a new element called proto-element
        Polymer({
            is: "timeline-element",
            properties: {
                name: { type: String },
                description: { type: String },
                width: { type: Number },
                height: { type: Number },
                color: { type: String, value: "#A8AAFF" },
                items: {
                    type: Array
                }
            },
            observers: ["itemsAddedOrRemoved(items.splices)"],
            itemsAddedOrRemoved: function (changeRecord) {
                setTimeout(function () {
                    this.updateChart();
                }.bind(this), 50);
            },
            ready: function () {
                this.attachedFired = true;
                this.width = this.width || 600;
                this.height = this.height || 250;

                setTimeout(function () {
                    this.initChart();
                }.bind(this), 50);
            },
            initChart: function () {
                if (!this.attachedFired)
                    return;
                var me = this;
                //console.warn(me.color);
                //Width and height
                var w = this.width;
                var h = this.height;

                var key = me.key = function (d) {
                    return d.Key;
                };
                var label = me.label = function (d) {
                    if (d.Value > 0 && d.Predicted > 0)
                        return d.Value + " (" + d.Predicted + "?)";
                    else if (d.Value > 0)
                        return d.Value;
                    else if (d.Predicted > 0)
                        return d.Predicted + "?";
                    return "";
                }

                me.xScale = d3.scale.ordinal()
                                .domain(d3.range(this.items.length))
                                .rangeRoundBands([0, w], 0.05);

                me.yScale = d3.scale.linear()
                                .domain([0, d3.max(this.items, function (d) { return Math.max(d.Predicted, d.Value); })])
                                .range([0, h]);

                //Create SVG element
                var svg = me.svg = d3.select(this.$.chart)
                            .append("svg")
                            .attr("width", w)
                            .attr("height", h);

                var items = me.svg.selectAll(".item")
                   .data(me.items, me.key)
                   .enter()
                   .append("g")
                   .attr("class", "item")
                   .attr("transform", function (d, i) { return "translate(" + me.xScale(i) + ",0)"; });

                items.selectAll("rect")
                   .data(function (d) { return [d.Predicted, d.Value]; })
                   .enter().append("rect")
                   .attr("y", function (d) {
                       return h - me.yScale(d);
                   })
                   .attr("width", me.xScale.rangeBand())
                   .attr("height", function (d) {
                       return me.yScale(d);
                   })
                   .attr("fill", function (d) {
                       return me.color;
                   });

                //Create labels
                items.selectAll("text")
                   .data(function (d) { return [d]; })
                   .enter()
                   .append("text")
                   .text(label)
                   .attr("x", function (d, i) {
                       return me.xScale.rangeBand() / 2;
                   })
                   .attr("y", function (d) {
                       return h - me.yScale(Math.max(d.Predicted, d.Value)) - 5;
                   })
                   .attr("class", "label");
                this.initialized = true;
            },
            updateChart: function () {
                if (!this.initialized)
                    return;

                var me = this;
                //Width and height
                var w = this.width;
                var h = this.height;

                //Update scale domain
                me.yScale.domain([0, d3.max(this.items, function (d) { return Math.max(d.Predicted, d.Value); })])
                me.xScale.domain(d3.range(me.items.length));

                var items = me.svg.selectAll(".item")
                   .data(me.items, me.key)
                   .attr("transform", function (d, i) { return "translate(" + me.xScale(i) + ",0)"; });

                items.enter()
                   .append("g")
                   .attr("class", "item")
                   .attr("transform", function (d, i) { return "translate(" + me.xScale(i) + ",0)"; });
                
                //Exit…
                items.exit()
                    .transition()
                    .duration(500)
                    .attr("transform", function (d, i) { return "translate(" + -me.xScale.rangeBand() + ",0)"; })  // <-- Exit stage left
                    .remove();
                
                items.selectAll("rect")
                   .data(function (d) { return [d.Predicted, d.Value]; })
                   .enter().append("rect")
                   .attr("y", function (d) {
                       return h - me.yScale(d);
                   })
                   .attr("width", me.xScale.rangeBand())
                   .attr("height", function (d) {
                       return me.yScale(d);
                   })
                   .attr("fill", function (d) {
                       return me.color;
                   });

                items.selectAll("rect")
                    .attr("width", me.xScale.rangeBand())
                    .transition()
                    .duration(500)
                    .attr("y", function (d) {
                        return h - me.yScale(d);
                    })
                   .attr("height", function (d) {
                       return me.yScale(d);
                   })
                   .attr("fill", function (d) {
                       return me.color;
                   });

                ////Update all labels
                var labels = items.selectAll("text")
                   .data(function (d) { return [d]; });

                ////Exit…
                labels.exit()
                    .transition()
                    .duration(500)
                    .attr("x", -me.xScale.rangeBand())  // <-- Exit stage left
                    .remove();

                labels.enter()
                   .append("text")
                   .text(me.label)
                   .attr("x", function (d, i) {
                       return me.xScale.rangeBand() / 2;
                   })
                   .attr("y", function (d) {
                       return h - me.yScale(Math.max(d.Predicted, d.Value)) - 5;
                   })
                   .attr("class", "label");

                labels
                   .attr("x", function (d, i) {
                       return me.xScale.rangeBand() / 2;
                   })
                   .transition()
                   //.delay(function (d, i) {
                   //    return i / dataset.length * 1000;
                   //})
                   .duration(500)
                   .text(me.label)
                   .attr("y", function (d) {
                       return h - me.yScale(Math.max(d.Predicted, d.Value)) - 5;
                   });
            }
        });
    </script>

</dom-module>